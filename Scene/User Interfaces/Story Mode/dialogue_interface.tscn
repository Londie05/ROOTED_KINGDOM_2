[gd_scene load_steps=8 format=3 uid="uid://dkgrs28nbmk1"]

[ext_resource type="Texture2D" uid="uid://dmc1sdajme8vi" path="res://Asset/User Interface/%Storymode%/dialogue_border.png" id="1_1unjk"]
[ext_resource type="FontFile" uid="uid://dtdw2k1jvjn37" path="res://Asset/Fonts/times.ttf" id="2_14j54"]
[ext_resource type="Texture2D" uid="uid://drrunbeatodhw" path="res://Asset/User Interface/%Storymode%/name_border.png" id="3_kus0a"]

[sub_resource type="GDScript" id="GDScript_lafey"]
script/source = "extends Control

@onready var Dialogue_ui: RichTextLabel = $\"MarginContainer/Control/Dialogue Panel Container/MarginContainer/Dialogue\"
@onready var Dialogue_speaker: Label = $\"MarginContainer/Control/Speaker PanelContainer/MarginContainer/Speakername\"
@onready var dialogue_panel = $\"MarginContainer/Control/Dialogue Panel Container\"
@onready var speaker_panel = $\"MarginContainer/Control/Speaker PanelContainer\"

@onready var speaker_margin_container = $\"MarginContainer/Control/Speaker PanelContainer/MarginContainer\"

var animate_text:= true
var animation_speed:= 30.0

# We store the original size so we can reset it before each calculation
var original_font_size: int = 0

func _ready() -> void:
	Dialogue_ui.visible_ratio = 0.0
	# Capture the starting size from the label settings
	if Dialogue_speaker.label_settings:
		# IMPORTANT: Duplicate the resource so changes don't affect other labels
		Dialogue_speaker.label_settings = Dialogue_speaker.label_settings.duplicate()
		original_font_size = Dialogue_speaker.label_settings.font_size

func _process(delta: float) -> void:
	if animate_text and Dialogue_ui.text.length() > 0:
		if Dialogue_ui.visible_ratio < 1.0:
			Dialogue_ui.visible_ratio += (1.0 / Dialogue_ui.text.length()) * (animation_speed * delta)
		else:
			animate_text = false

func shrink_text_to_fit(new_name: String = \"\") -> void:
	var label = Dialogue_speaker
	
	if not label.label_settings:
		return
	
	# 1. Reset to the original font size before measuring
	label.label_settings.font_size = original_font_size
	
	if not new_name.is_empty():
		label.text = new_name
	
	if label.text.is_empty():
		return
	
	# Wait for layout to settle
	await get_tree().process_frame
	await get_tree().process_frame
	
	# 2. Get the font resource to measure width
	var font = label.label_settings.font if label.label_settings.font else label.get_theme_font(\"font\")
	
	# 3. Calculate dynamic padding from the MarginContainer constants
	# These constants (left and right) are what push the label inward
	var m_left = speaker_margin_container.get_theme_constant(\"margin_left\")
	var m_right = speaker_margin_container.get_theme_constant(\"margin_right\")
	var total_margins = m_left + m_right
	
	# 4. Determine the limit (Width of the speaker box minus its internal margins)
	var box_limit = speaker_panel.custom_minimum_size.x
	if box_limit <= 0:
		box_limit = speaker_panel.size.x
	
	# Subtract the left/right margins and a small safety buffer (4px) 
	# to ensure the text doesn't touch the very edge of the margin
	var effective_max_width = box_limit - total_margins - 4

	if effective_max_width <= 0: return

	# 5. Iterative Shrinking
	# We start at the original size and step down until it fits inside the margins.
	var current_size = original_font_size
	var text_width = font.get_string_size(label.text, HORIZONTAL_ALIGNMENT_LEFT, -1, current_size).x
	
	while text_width > effective_max_width and current_size > 6:
		# Reduce size by 1px steps for high precision
		current_size -= 1
		text_width = font.get_string_size(label.text, HORIZONTAL_ALIGNMENT_LEFT, -1, current_size).x
	
	# Apply the final size
	label.label_settings.font_size = current_size

func set_speaker_name(speaker_name: String) -> void:
	shrink_text_to_fit(speaker_name)
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_3as14"]
bg_color = Color(0.5764706, 0.28235295, 0.05882353, 0.77254903)
corner_radius_top_left = 3
corner_radius_top_right = 3
corner_radius_bottom_right = 3
corner_radius_bottom_left = 3
corner_detail = 5

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_ssgid"]
bg_color = Color(0.5764706, 0.28235295, 0.05882353, 1)
draw_center = false

[sub_resource type="LabelSettings" id="LabelSettings_56hp3"]
font = ExtResource("2_14j54")
font_size = 24

[node name="Dialogue Interface" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_top = 3.0
offset_right = 2.0
offset_bottom = 3.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_lafey")

[node name="MarginContainer" type="MarginContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 17
theme_override_constants/margin_top = 17
theme_override_constants/margin_right = 17
theme_override_constants/margin_bottom = 17

[node name="Control" type="Control" parent="MarginContainer"]
layout_mode = 2

[node name="Dialogue Panel Container" type="PanelContainer" parent="MarginContainer/Control"]
clip_contents = true
layout_mode = 1
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_top = -198.0
grow_horizontal = 2
grow_vertical = 0
theme_override_styles/panel = SubResource("StyleBoxFlat_3as14")

[node name="TextureRect" type="TextureRect" parent="MarginContainer/Control/Dialogue Panel Container"]
layout_mode = 2
texture = ExtResource("1_1unjk")
expand_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="MarginContainer/Control/Dialogue Panel Container"]
layout_mode = 2
theme_override_constants/margin_left = 34
theme_override_constants/margin_top = 34
theme_override_constants/margin_right = 34
theme_override_constants/margin_bottom = 34

[node name="Dialogue" type="RichTextLabel" parent="MarginContainer/Control/Dialogue Panel Container/MarginContainer"]
layout_mode = 2
size_flags_stretch_ratio = 8.88
theme_override_fonts/normal_font = ExtResource("2_14j54")
theme_override_font_sizes/normal_font_size = 23
text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."
scroll_active = false

[node name="Speaker PanelContainer" type="PanelContainer" parent="MarginContainer/Control"]
layout_mode = 1
anchors_preset = 2
anchor_top = 1.0
anchor_bottom = 1.0
offset_top = -258.335
offset_right = 500.0
offset_bottom = -196.78
grow_vertical = 0
theme_override_styles/panel = SubResource("StyleBoxFlat_ssgid")

[node name="TextureRect" type="TextureRect" parent="MarginContainer/Control/Speaker PanelContainer"]
layout_mode = 2
texture = ExtResource("3_kus0a")
expand_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="MarginContainer/Control/Speaker PanelContainer"]
layout_mode = 2
theme_override_constants/margin_left = 35
theme_override_constants/margin_top = 20
theme_override_constants/margin_right = 100

[node name="Speakername" type="Label" parent="MarginContainer/Control/Speaker PanelContainer/MarginContainer"]
layout_mode = 2
text = "Lattle Brown-haired Woman"
label_settings = SubResource("LabelSettings_56hp3")
clip_text = true
