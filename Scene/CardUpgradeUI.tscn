[gd_scene load_steps=5 format=3 uid="uid://cpq1bk7hf2i5t"]

[ext_resource type="PackedScene" uid="uid://diw3xv0en0ynt" path="res://Scene/User Interfaces/UI scenes/background_i.tscn" id="14_5yfo5"]
[ext_resource type="Texture2D" uid="uid://dcm4yl4kcn7wn" path="res://Asset/Backgrounds/gem_1.webp" id="14_6kr27"]
[ext_resource type="Texture2D" uid="uid://rjoebry8l2at" path="res://Asset/Backgrounds/gem_3.webp" id="15_5yfo5"]

[sub_resource type="GDScript" id="GDScript_6kr27"]
script/source = "extends Control

# --- 1. DATA SETUP ---
# Drag all your Card Resources (Slash.tres, Fireball.tres) here in the Inspector!
@export var all_cards_in_game: Array[CardData] = []

# UI References (Connect these unique names to your nodes if you use %UniqueName, 
# or just use $Path/To/Node)
@onready var small_gem_label =$MarginContainer/HBoxContainer/SmallGemHolder/SmallGemLabel
@onready var crystal_label = $MarginContainer/HBoxContainer/CrystalGemHolder/CrystalLabel

@onready var grid_container = $MainLayout/ScrollContainer/GridContainer
@onready var details_panel = $DetailsPanel
@onready var card_name_label = $DetailsPanel/VBoxContainer/CardNameLabel
@onready var stats_label = $DetailsPanel/VBoxContainer/StatsLabel
@onready var cost_label = $DetailsPanel/VBoxContainer/CostLabel
@onready var upgrade_button = $DetailsPanel/VBoxContainer/UpgradeButton
@onready var card_image = $DetailsPanel/VBoxContainer/CardImage
@onready var dim_background = $DimBackground

# Track what the player is currently looking at
var current_selected_card: CardData = null

func _ready():
	# 1. Update the currency display
	update_currency_display()
	
	# 2. Clear dummy buttons in the grid (if any)
	for child in grid_container.get_children():
		child.queue_free()
		
	# 3. Create a button for every card in the game
	for data in all_cards_in_game:
		create_card_button(data)
	
	# 4. Hide details panel until a card is picked
	details_panel.visible = false
	dim_background.visible = false
# --- 2. SETUP THE GRID ---
func create_card_button(data: CardData):
	var card_btn = TextureButton.new()
	card_btn.texture_normal = data.card_image
	card_btn.ignore_texture_size = true
	card_btn.stretch_mode = TextureButton.STRETCH_KEEP_ASPECT_CENTERED
	card_btn.custom_minimum_size = Vector2(140, 200)
	
	# --- ADD THE BLACK OUTLINE HERE ---
	var outline = ReferenceRect.new()
	# This makes the outline match the exact size of the card button
	outline.set_anchors_and_offsets_preset(Control.PRESET_FULL_RECT)
	
	# Styling the line
	outline.border_color = Color.BLACK
	outline.border_width = 3.0 # Increase this for a thicker comic-book look
	outline.editor_only = false # IMPORTANT: Without this, it won't show in the game!
	
	# Make sure the outline is \"mouse passive\" so it doesn't block clicks
	outline.mouse_filter = Control.MOUSE_FILTER_IGNORE 
	
	card_btn.add_child(outline)
	# ----------------------------------
	
	card_btn.pressed.connect(select_card.bind(data))
	grid_container.add_child(card_btn)

# --- 3. DISPLAY DETAILS (The Math Part) ---
func select_card(data: CardData):
	current_selected_card = data
	
	# Show the popup and the dark background
	details_panel.visible = true
	dim_background.visible = true
	
	card_name_label.text = data.card_name + \" [Lv.\" + str(Global.get_card_level_number(data)) + \"]\"
	card_image.texture = data.card_image
	
	# Build Stats (Using RichText if your label supports it)
	var stats_text = \"\"
	if data.damage > 0:
		var cur = Global.get_card_damage(data)
		stats_text += \"Damage: \" + str(cur) + \" -> [color=green]\" + str(cur + data.damage_growth) + \"[/color]\\n\"
	# ... (add shield and heal logic same as before)
	
	stats_label.text = stats_text
	cost_label.text = \"Materials Needed: \" + str(data.upgrade_cost)
	
	# Button check
	upgrade_button.disabled = Global.small_gems < data.upgrade_cost

# --- 4. BUTTON SIGNALS ---
func _on_upgrade_button_pressed():
	if current_selected_card == null: return
	
	var success = Global.attempt_upgrade(current_selected_card)
	
	if success:
		# Now we call the updated display function
		update_currency_display()
		select_card(current_selected_card)

func _on_back_button_pressed():
	# Go back to Main Menu (Change path if needed)
	get_tree().change_scene_to_file(\"res://Scene/User Interfaces/UI scenes/main_menu.tscn\")

func update_currency_display():
	small_gem_label.text = str(Global.small_gems)
	crystal_label.text = str(Global.crystal_gems)

func _on_cancel_pressed() -> void:
	details_panel.visible = false
	dim_background.visible = false
"

[node name="CardUpgradeUi" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_6kr27")

[node name="Background2" type="Control" parent="."]
anchors_preset = 0
offset_right = 1152.0
offset_bottom = 651.0

[node name="Background I" parent="Background2" instance=ExtResource("14_5yfo5")]
layout_mode = 1

[node name="Background" type="TextureRect" parent="."]
visible = false
layout_mode = 0
offset_right = 1152.0
offset_bottom = 648.0

[node name="TopBar" type="HBoxContainer" parent="."]
layout_mode = 0
offset_right = 422.0
offset_bottom = 66.0
theme_override_constants/separation = 50

[node name="BackButton" type="Button" parent="TopBar"]
custom_minimum_size = Vector2(100, 0)
layout_mode = 2
text = "Back"

[node name="TitleLabel" type="Label" parent="TopBar"]
layout_mode = 2
text = "Card Upgrades"

[node name="MainLayout" type="HBoxContainer" parent="."]
layout_mode = 1
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_top = -200.0
grow_horizontal = 2
grow_vertical = 0

[node name="ScrollContainer" type="ScrollContainer" parent="MainLayout"]
custom_minimum_size = Vector2(100, 200)
layout_direction = 2
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 8
size_flags_stretch_ratio = 3.1
horizontal_scroll_mode = 2
vertical_scroll_mode = 0
scroll_deadzone = 2

[node name="GridContainer" type="HBoxContainer" parent="MainLayout/ScrollContainer"]
custom_minimum_size = Vector2(50, 50)
layout_mode = 2
theme_override_constants/separation = 10

[node name="DimBackground" type="ColorRect" parent="."]
visible = false
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0.11, 0.11, 0.11, 0.68235296)

[node name="DetailsPanel" type="Panel" parent="."]
layout_mode = 0
offset_left = 448.0
offset_top = 70.0
offset_right = 755.0
offset_bottom = 526.0

[node name="VBoxContainer" type="VBoxContainer" parent="DetailsPanel"]
layout_mode = 0
offset_top = -4.0
offset_right = 300.0
offset_bottom = 456.0

[node name="Cancel" type="Button" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(0, 50)
layout_mode = 2
theme_override_colors/font_color = Color(0.93, 0.93, 0.93, 1)
text = "Cancel
"

[node name="CardImage" type="TextureRect" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(200, 250)
layout_mode = 2
expand_mode = 1
stretch_mode = 5

[node name="CardNameLabel" type="Label" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(0, 30)
layout_mode = 2

[node name="StatsLabel" type="RichTextLabel" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(0, 30)
layout_mode = 2
bbcode_enabled = true

[node name="CostLabel" type="Label" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(0, 30)
layout_mode = 2
text = "Cost: 50"

[node name="UpgradeButton" type="Button" parent="DetailsPanel/VBoxContainer"]
custom_minimum_size = Vector2(0, 50)
layout_mode = 2
text = "Upgrade
"

[node name="MarginContainer" type="MarginContainer" parent="."]
layout_mode = 0
offset_left = 842.0
offset_top = 16.0
offset_right = 1152.0
offset_bottom = 96.0
theme_override_constants/margin_left = 20
theme_override_constants/margin_top = 20
theme_override_constants/margin_right = 20
theme_override_constants/margin_bottom = 20

[node name="HBoxContainer" type="HBoxContainer" parent="MarginContainer"]
layout_mode = 2
theme_override_constants/separation = 20

[node name="SmallGemHolder" type="HBoxContainer" parent="MarginContainer/HBoxContainer"]
custom_minimum_size = Vector2(125, 0)
layout_mode = 2
theme_override_constants/separation = 20

[node name="TextureRect" type="TextureRect" parent="MarginContainer/HBoxContainer/SmallGemHolder"]
custom_minimum_size = Vector2(60, 40)
layout_mode = 2
texture = ExtResource("14_6kr27")
expand_mode = 1
stretch_mode = 5

[node name="SmallGemLabel" type="Label" parent="MarginContainer/HBoxContainer/SmallGemHolder"]
custom_minimum_size = Vector2(20, 0)
layout_mode = 2
theme_override_font_sizes/font_size = 25
text = "0"

[node name="CrystalGemHolder" type="HBoxContainer" parent="MarginContainer/HBoxContainer"]
custom_minimum_size = Vector2(125, 0)
layout_mode = 2
theme_override_constants/separation = 20

[node name="TextureRect" type="TextureRect" parent="MarginContainer/HBoxContainer/CrystalGemHolder"]
custom_minimum_size = Vector2(30, 40)
layout_mode = 2
texture = ExtResource("15_5yfo5")
expand_mode = 1
stretch_mode = 5

[node name="CrystalLabel" type="Label" parent="MarginContainer/HBoxContainer/CrystalGemHolder"]
custom_minimum_size = Vector2(20, 0)
layout_mode = 2
theme_override_font_sizes/font_size = 25
text = "0"

[connection signal="pressed" from="TopBar/BackButton" to="." method="_on_back_button_pressed"]
[connection signal="pressed" from="DetailsPanel/VBoxContainer/Cancel" to="." method="_on_cancel_pressed"]
[connection signal="pressed" from="DetailsPanel/VBoxContainer/UpgradeButton" to="." method="_on_upgrade_button_pressed"]
